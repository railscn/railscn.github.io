<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Action Text Overview — Ruby on Rails 指南</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/highlight.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/backtop.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="icon" type="image/x-icon" />
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/clipboard.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/back2top.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Action Text Overview — Ruby on Rails 指南" />
  <meta name="description" content="Action Text OverviewThis guide provides you with all you need to get started in handling rich text content.After reading this guide, you will know: How to configure Action Text. How to handle rich text content. How to style rich text content and attachments." />
  <meta property="og:description" content="Action Text OverviewThis guide provides you with all you need to get started in handling rich text content.After reading this guide, you will know: How to configure Action Text. How to handle rich text content. How to style rich text content and attachments." />
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="Ruby on Rails 指南" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div>
    <div id="version-badge">edge</div>
  </div>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多信息在 <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多 Ruby on Rails 信息
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">博客</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">指南</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">论坛</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">在 GitHub 做贡献</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="返回首页">railsguides.cn</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首页</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">指南目录</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <dl class="guides-section-container">
                <div class="guides-section">
                  <dt>从这里开始</dt>
                  <dd><a href="getting_started.html">Rails 入门</a></dd>
                </div>
                <div class="guides-section">
                  <dt>模型（Model）</dt>
                  <dd><a href="active_record_basics.html">Active Record 基础</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record 修改</a></dd>
                  <dd><a href="active_record_validations.html">Active Record 验证</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record 回调</a></dd>
                  <dd><a href="association_basics.html">Active Record 关联</a></dd>
                  <dd><a href="active_record_querying.html">Active Record 查询接口</a></dd>
                </div>
                <div class="guides-section">
                  <dt>视图（View）</dt>
                  <dd><a href="layouts_and_rendering.html">Rails 的模板布局与视图呈现</a></dd>
                  <dd><a href="form_helpers.html">Action View 表单辅助方法</a></dd>
                </div>
                <div class="guides-section">
                  <dt>控制器（Controller）</dt>
                  <dd><a href="action_controller_overview.html">Action Controller 概览</a></dd>
                  <dd><a href="routing.html">Rails 路由从入门到精通</a></dd>
                </div>
                <div class="guides-section">
                  <dt>其他组件</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support 核心扩展</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer 基础</a></dd>
                  <dd><a href="active_job_basics.html">Active Job 基础</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage 概览</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable 概览</a></dd>
                  <dd><a href="webpacker.html">Webpacker</a></dd>
                </div>
                <div class="guides-section">
                  <dt>高级指南</dt>
                  <dd><a href="i18n.html">Rails 国际化（I18n） API</a></dd>
                  <dd><a href="testing.html">Rails 应用程序的测试</a></dd>
                  <dd><a href="security.html">Rails 应用程序的安全</a></dd>
                  <dd><a href="debugging_rails_applications.html">Rails 应用程序的调试</a></dd>
                  <dd><a href="configuring.html">Rails 应用程序的配置</a></dd>
                  <dd><a href="command_line.html">Rails 命令行</a></dd>
                  <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">自动加载和重载常量</a></dd>
                  <dd><a href="classic_to_zeitwerk_howto.html">如何从传统过渡到 Zeitwerk</a></dd>
                  <dd><a href="caching_with_rails.html">Rails 缓存概览</a></dd>
                  <dd><a href="api_app.html">用 Rails 只做应用程序后台 API</a></dd>
                  <dd><a href="active_record_multiple_databases.html">Active Record 支持多数据库</a></dd>
                </div>
                <div class="guides-section">
                  <dt>扩展 Rails</dt>
                  <dd><a href="rails_on_rack.html">Rack 中的 Rails</a></dd>
                  <dd><a href="generators.html">创建和定制 Rails 生成器/模板</a></dd>
                </div>
                <div class="guides-section">
                  <dt>贡献</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">为 Ruby on Rails 贡献</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API 文档指南</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">指南大纲</a></dd>
                </div>
                <div class="guides-section">
                  <dt>政策（Policies）</dt>
                  <dd><a href="maintenance_policy.html">维护政策</a></dd>
                </div>
                <div class="guides-section">
                  <dt>版本备忘</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">更新 Ruby on Rails</a></dd>
                  <dd><a href="7_0_release_notes.html">7.0 版本 —— 2021 年 12 月</a></dd>
                  <dd><a href="6_1_release_notes.html">6.1 版本 —— 2020 年 12 月</a></dd>
                  <dd><a href="6_0_release_notes.html">6.0 版本 —— 2019 年 9 月</a></dd>
                  <dd><a href="5_2_release_notes.html">5.2 版本 —— 2018 年 4 月</a></dd>
                  <dd><a href="5_1_release_notes.html">5.1 版本 —— 2017 年 4 月</a></dd>
                  <dd><a href="5_0_release_notes.html">5.0 版本 —— 2016 年 6 月</a></dd>
                  <dd><a href="4_2_release_notes.html">4.2 版本 —— 2014 年 12 月</a></dd>
                  <dd><a href="4_1_release_notes.html">4.1 版本 —— 2014 年 4 月</a></dd>
                  <dd><a href="4_0_release_notes.html">4.0 版本 —— 2013 年 6 月</a></dd>
                  <dd><a href="3_2_release_notes.html">3.2 版本 —— 2012 年 1 月</a></dd>
                  <dd><a href="3_1_release_notes.html">3.1 版本 —— 2011 年 8 月</a></dd>
                  <dd><a href="3_0_release_notes.html">3.0 版本 —— 2010 年 8 月</a></dd>
                  <dd><a href="2_3_release_notes.html">2.3 版本 —— 2009 年 3 月</a></dd>
                  <dd><a href="2_2_release_notes.html">2.2 版本 —— 2008 年 11 月</a></dd>
                </div>
            </dl>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">贡献</a></li>
        <li><a class="nav-item" href="about.html">关于</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">指南目录</option>
              <optgroup label="从这里开始">
                  <option value="getting_started.html">Rails 入门</option>
              </optgroup>
              <optgroup label="模型（Model）">
                  <option value="active_record_basics.html">Active Record 基础</option>
                  <option value="active_record_migrations.html">Active Record 修改</option>
                  <option value="active_record_validations.html">Active Record 验证</option>
                  <option value="active_record_callbacks.html">Active Record 回调</option>
                  <option value="association_basics.html">Active Record 关联</option>
                  <option value="active_record_querying.html">Active Record 查询接口</option>
              </optgroup>
              <optgroup label="视图（View）">
                  <option value="layouts_and_rendering.html">Rails 的模板布局与视图呈现</option>
                  <option value="form_helpers.html">Action View 表单辅助方法</option>
              </optgroup>
              <optgroup label="控制器（Controller）">
                  <option value="action_controller_overview.html">Action Controller 概览</option>
                  <option value="routing.html">Rails 路由从入门到精通</option>
              </optgroup>
              <optgroup label="其他组件">
                  <option value="active_support_core_extensions.html">Active Support 核心扩展</option>
                  <option value="action_mailer_basics.html">Action Mailer 基础</option>
                  <option value="active_job_basics.html">Active Job 基础</option>
                  <option value="active_storage_overview.html">Active Storage 概览</option>
                  <option value="action_cable_overview.html">Action Cable 概览</option>
                  <option value="webpacker.html">Webpacker</option>
              </optgroup>
              <optgroup label="高级指南">
                  <option value="i18n.html">Rails 国际化（I18n） API</option>
                  <option value="testing.html">Rails 应用程序的测试</option>
                  <option value="security.html">Rails 应用程序的安全</option>
                  <option value="debugging_rails_applications.html">Rails 应用程序的调试</option>
                  <option value="configuring.html">Rails 应用程序的配置</option>
                  <option value="command_line.html">Rails 命令行</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</option>
                  <option value="autoloading_and_reloading_constants.html">自动加载和重载常量</option>
                  <option value="classic_to_zeitwerk_howto.html">如何从传统过渡到 Zeitwerk</option>
                  <option value="caching_with_rails.html">Rails 缓存概览</option>
                  <option value="api_app.html">用 Rails 只做应用程序后台 API</option>
                  <option value="active_record_multiple_databases.html">Active Record 支持多数据库</option>
              </optgroup>
              <optgroup label="扩展 Rails">
                  <option value="rails_on_rack.html">Rack 中的 Rails</option>
                  <option value="generators.html">创建和定制 Rails 生成器/模板</option>
              </optgroup>
              <optgroup label="贡献">
                  <option value="contributing_to_ruby_on_rails.html">为 Ruby on Rails 贡献</option>
                  <option value="api_documentation_guidelines.html">API 文档指南</option>
                  <option value="ruby_on_rails_guides_guidelines.html">指南大纲</option>
              </optgroup>
              <optgroup label="政策（Policies）">
                  <option value="maintenance_policy.html">维护政策</option>
              </optgroup>
              <optgroup label="版本备忘">
                  <option value="upgrading_ruby_on_rails.html">更新 Ruby on Rails</option>
                  <option value="7_0_release_notes.html">7.0 版本 —— 2021 年 12 月</option>
                  <option value="6_1_release_notes.html">6.1 版本 —— 2020 年 12 月</option>
                  <option value="6_0_release_notes.html">6.0 版本 —— 2019 年 9 月</option>
                  <option value="5_2_release_notes.html">5.2 版本 —— 2018 年 4 月</option>
                  <option value="5_1_release_notes.html">5.1 版本 —— 2017 年 4 月</option>
                  <option value="5_0_release_notes.html">5.0 版本 —— 2016 年 6 月</option>
                  <option value="4_2_release_notes.html">4.2 版本 —— 2014 年 12 月</option>
                  <option value="4_1_release_notes.html">4.1 版本 —— 2014 年 4 月</option>
                  <option value="4_0_release_notes.html">4.0 版本 —— 2013 年 6 月</option>
                  <option value="3_2_release_notes.html">3.2 版本 —— 2012 年 1 月</option>
                  <option value="3_1_release_notes.html">3.1 版本 —— 2011 年 8 月</option>
                  <option value="3_0_release_notes.html">3.0 版本 —— 2010 年 8 月</option>
                  <option value="2_3_release_notes.html">2.3 版本 —— 2009 年 3 月</option>
                  <option value="2_2_release_notes.html">2.2 版本 —— 2008 年 11 月</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Action Text Overview</h2><p>This guide provides you with all you need to get started in handling
rich text content.</p><p>After reading this guide, you will know:</p>
<ul>
<li>How to configure Action Text.</li>
<li>How to handle rich text content.</li>
<li>How to style rich text content and attachments.</li>
</ul>


                <div id="subCol" data-turbolinks="false">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />题要</h3>
            <ol class="chapters">
<li><a href="#what-is-action-text-questionmark">What is Action Text?</a></li>
<li><a href="#trix-compared-to-other-rich-text-editors">Trix compared to other rich text editors</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#creating-rich-text-content">Creating Rich Text content</a></li>
<li>
<a href="#rendering-rich-text-content">Rendering Rich Text content</a>

<ul>
<li><a href="#rendering-attachments">Rendering attachments</a></li>
</ul>
</li>
<li><a href="#avoid-n-1-queries">Avoid N+1 queries</a></li>
<li><a href="#api-backend-development">API / Backend development</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="what-is-action-text-questionmark"><a class="anchorlink" href="#what-is-action-text-questionmark" data-turbolinks="false">1 What is Action Text?</a></h3><p>Action Text brings rich text content and editing to Rails. It includes
the <a href="https://trix-editor.org">Trix editor</a> that handles everything from formatting
to links to quotes to lists to embedded images and galleries.
The rich text content generated by the Trix editor is saved in its own
RichText model that's associated with any existing Active Record model in the application.
Any embedded images (or other attachments) are automatically stored using
Active Storage and associated with the included RichText model.</p><h3 id="trix-compared-to-other-rich-text-editors"><a class="anchorlink" href="#trix-compared-to-other-rich-text-editors" data-turbolinks="false">2 Trix compared to other rich text editors</a></h3><p>Most WYSIWYG editors are wrappers around HTML’s <code>contenteditable</code> and <code>execCommand</code> APIs,
designed by Microsoft to support live editing of web pages in Internet Explorer 5.5,
and <a href="https://blog.whatwg.org/the-road-to-html-5-contenteditable#history">eventually reverse-engineered</a>
and copied by other browsers.</p><p>Because these APIs were never fully specified or documented,
and because WYSIWYG HTML editors are enormous in scope, each
browser's implementation has its own set of bugs and quirks,
and JavaScript developers are left to resolve the inconsistencies.</p><p>Trix sidesteps these inconsistencies by treating contenteditable
as an I/O device: when input makes its way to the editor, Trix converts that input
into an editing operation on its internal document model, then re-renders
that document back into the editor. This gives Trix complete control over what
happens after every keystroke, and avoids the need to use execCommand at all.</p><h3 id="installation"><a class="anchorlink" href="#installation" data-turbolinks="false">3 Installation</a></h3><p>Run <code>bin/rails action_text:install</code> to add the Yarn package and copy over the necessary migration. Also, you need to set up Active Storage for embedded images and other attachments. Please refer to the <a href="active_storage_overview.html">Active Storage Overview</a> guide.</p><div class="note"><p>Action Text uses polymorphic relationships with the <code>action_text_rich_texts</code> table so that it can be shared with all models that have rich text attributes. If your models with Action Text content use UUID values for identifiers, all models that use Action Text attributes will need to use UUID values for their unique identifiers. The generated migration for Action Text will also need to be updated to specify <code>type: :uuid</code> for the <code>:record</code> <code>references</code> line.</p></div><p>After the installation is complete, a Rails app should have the following changes:</p>
<ol>
<li>
<p>Both <code>trix</code> and <code>@rails/actiontext</code> should be required in your JavaScript entrypoint.</p>
<div class="code_container">
<pre><code class="highlight js"><span class="c1">// application.js</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">trix</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">@rails/actiontext</span><span class="dl">"</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='// application.js
import "trix"
import "@rails/actiontext"
'>复制</button>
</div>
</li>
<li><p>The <code>trix</code> stylesheet will be included together with Action Text styles in your <code>application.css</code> file.</p></li>
</ol>
<h3 id="creating-rich-text-content"><a class="anchorlink" href="#creating-rich-text-content" data-turbolinks="false">4 Creating Rich Text content</a></h3><p>Add a rich text field to an existing model:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/message.rb</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_rich_text</span> <span class="ss">:content</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/message.rb
class Message &lt; ApplicationRecord
  has_rich_text :content
end
">复制</button>
</div>
<p>or add rich text field while creating a new model using:</p><div class="code_container">
<pre><code class="highlight plaintext">bin/rails generate model Message content:rich_text
</code></pre>
<button class="clipboard-button" data-clipboard-text="bin/rails generate model Message content:rich_text
">复制</button>
</div>
<p><strong>Note:</strong> you don't need to add a <code>content</code> field to your <code>messages</code> table.</p><p>Then use <a href="https://edgeapi.rubyonrails.org/classes/ActionView/Helpers/FormHelper.html#method-i-rich_text_area"><code>rich_text_area</code></a> to refer to this field in the form for the model:</p><div class="code_container">
<pre><code class="highlight erb"><span class="c">&lt;%# app/views/messages/_form.html.erb %&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="n">message</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:content</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">rich_text_area</span> <span class="ss">:content</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;%# app/views/messages/_form.html.erb %&gt;
&lt;%= form_with model: message do |form| %&gt;
  &lt;div class="field"&gt;
    &lt;%= form.label :content %&gt;
    &lt;%= form.rich_text_area :content %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
'>复制</button>
</div>
<p>And finally, display the sanitized rich text on a page:</p><div class="code_container">
<pre><code class="highlight erb"><span class="cp">&lt;%=</span> <span class="vi">@message</span><span class="p">.</span><span class="nf">content</span> <span class="cp">%&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%= @message.content %&gt;
">复制</button>
</div>
<p>To accept the rich text content, all you have to do is permit the referenced attribute:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">MessagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">message</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">create!</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:message</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="ss">:content</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="n">message</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="class MessagesController &lt; ApplicationController
  def create
    message = Message.create! params.require(:message).permit(:title, :content)
    redirect_to message
  end
end
">复制</button>
</div>
<h3 id="rendering-rich-text-content"><a class="anchorlink" href="#rendering-rich-text-content" data-turbolinks="false">5 Rendering Rich Text content</a></h3><p>By default, Action Text will render rich text content inside an element with the
<code>.trix-content</code> class:</p><div class="code_container">
<pre><code class="highlight erb"><span class="c">&lt;%# app/views/layouts/action_text/contents/_content.html.erb %&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"trix-content"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;%# app/views/layouts/action_text/contents/_content.html.erb %&gt;
&lt;div class="trix-content"&gt;
  &lt;%= yield %&gt;
&lt;/div&gt;
'>复制</button>
</div>
<p>Elements with this class, as well as the Action Text editor, are styled by the
<a href="https://raw.githubusercontent.com/basecamp/trix/master/dist/trix.css"><code>trix</code> stylesheet</a>.
To provide your own styles instead, remove the <code>= require trix</code> line from the
<code>app/assets/stylesheets/actiontext.css</code> stylesheet created by the installer.</p><p>To customize the HTML rendered around rich text content, edit the
<code>app/views/layouts/action_text/contents/_content.html.erb</code> layout created by the
installer.</p><p>To customize the HTML rendered for embedded images and other attachments (known
as blobs), edit the <code>app/views/active_storage/blobs/_blob.html.erb</code> template
created by the installer.</p><h4 id="rendering-attachments"><a class="anchorlink" href="#rendering-attachments" data-turbolinks="false">5.1 Rendering attachments</a></h4><p>In addition to attachments uploaded through Active Storage, Action Text can
embed anything that can be resolved by a <a href="https://github.com/rails/globalid#signed-global-ids">Signed
GlobalID</a>.</p><p>Action Text renders embedded <code>&lt;action-text-attachment&gt;</code> elements by resolving
their <code>sgid</code> attribute into an instance. Once resolved, that instance is passed
along to
<a href="https://edgeapi.rubyonrails.org/classes/ActionView/Helpers/RenderingHelper.html#method-i-render"><code>render</code></a>.
The resulting HTML is embedded as a descendant of the <code>&lt;action-text-attachment&gt;</code>
element.</p><p>For example, consider a <code>User</code> model:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one_attached</span> <span class="ss">:avatar</span>
<span class="k">end</span>

<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">to_global_id</span><span class="p">.</span><span class="nf">to_s</span> <span class="c1">#=&gt; gid://MyRailsApp/User/1</span>
<span class="n">user</span><span class="p">.</span><span class="nf">to_signed_global_id</span><span class="p">.</span><span class="nf">to_s</span> <span class="c1">#=&gt; BAh7CEkiCG…</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="# app/models/user.rb
class User &lt; ApplicationRecord
  has_one_attached :avatar
end

user = User.find(1)
user.to_global_id.to_s #=&gt; gid://MyRailsApp/User/1
user.to_signed_global_id.to_s #=&gt; BAh7CEkiCG…
">复制</button>
</div>
<p>Next, consider some rich text content that embeds an <code>&lt;action-text-attachment&gt;</code>
element that references the <code>User</code> instance's signed GlobalID:</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;p&gt;</span>Hello, <span class="nt">&lt;action-text-attachment</span> <span class="na">sgid=</span><span class="s">"BAh7CEkiCG…"</span><span class="nt">&gt;&lt;/action-text-attachment&gt;</span>.<span class="nt">&lt;/p&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;p&gt;Hello, &lt;action-text-attachment sgid="BAh7CEkiCG…"&gt;&lt;/action-text-attachment&gt;.&lt;/p&gt;
'>复制</button>
</div>
<p>Action Text resolves uses the "BAh7CEkiCG…" String to resolve the <code>User</code>
instance. Next, consider the application's <code>users/user</code> partial:</p><div class="code_container">
<pre><code class="highlight erb"><span class="c">&lt;%# app/views/users/_user.html.erb %&gt;</span>
<span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span> <span class="cp">%&gt;</span> <span class="cp">&lt;%=</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%# app/views/users/_user.html.erb %&gt;
&lt;span&gt;&lt;%= image_tag user.avatar %&gt; &lt;%= user.name %&gt;&lt;/span&gt;
">复制</button>
</div>
<p>The resulting HTML rendered by Action Text would look something like:</p><div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;p&gt;</span>Hello, <span class="nt">&lt;action-text-attachment</span> <span class="na">sgid=</span><span class="s">"BAh7CEkiCG…"</span><span class="nt">&gt;&lt;span&gt;&lt;img</span> <span class="na">src=</span><span class="s">"..."</span><span class="nt">&gt;</span> Jane Doe<span class="nt">&lt;/span&gt;&lt;/action-text-attachment&gt;</span>.<span class="nt">&lt;/p&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;p&gt;Hello, &lt;action-text-attachment sgid="BAh7CEkiCG…"&gt;&lt;span&gt;&lt;img src="..."&gt; Jane Doe&lt;/span&gt;&lt;/action-text-attachment&gt;.&lt;/p&gt;
'>复制</button>
</div>
<p>To render a different partial, define <code>User#to_attachable_partial_path</code>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="k">def</span> <span class="nf">to_attachable_partial_path</span>
    <span class="s2">"users/attachable"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='class User &lt; ApplicationRecord
  def to_attachable_partial_path
    "users/attachable"
  end
end
'>复制</button>
</div>
<p>Then declare that partial. The <code>User</code> instance will be available as the <code>user</code>
partial-local variable:</p><div class="code_container">
<pre><code class="highlight erb"><span class="c">&lt;%# app/views/users/_attachable.html.erb %&gt;</span>
<span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">user</span><span class="p">.</span><span class="nf">avatar</span> <span class="cp">%&gt;</span> <span class="cp">&lt;%=</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="&lt;%# app/views/users/_attachable.html.erb %&gt;
&lt;span&gt;&lt;%= image_tag user.avatar %&gt; &lt;%= user.name %&gt;&lt;/span&gt;
">复制</button>
</div>
<p>To integrate with Action Text <code>&lt;action-text-attachment&gt;</code> element rendering, a
class must:</p>
<ul>
<li>include the <code>ActionText::Attachable</code> module</li>
<li>implement <code>#to_sgid(**options)</code> (made available through the <a href="https://github.com/rails/globalid#usage"><code>GlobalID::Identification</code> concern</a>)</li>
<li>(optional) declare <code>#to_attachable_partial_path</code>
</li>
</ul>
<p>By default, all <code>ActiveRecord::Base</code> descendants mix-in
<a href="https://github.com/rails/globalid#usage"><code>GlobalID::Identification</code> concern</a>, and are therefore
<code>ActionText::Attachable</code> compatible.</p><h3 id="avoid-n-1-queries"><a class="anchorlink" href="#avoid-n-1-queries" data-turbolinks="false">6 Avoid N+1 queries</a></h3><p>If you wish to preload the dependent <code>ActionText::RichText</code> model, assuming your rich text field is named <code>content</code>, you can use the named scope:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">with_rich_text_content</span> <span class="c1"># Preload the body without attachments.</span>
<span class="no">Message</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">with_rich_text_content_and_embeds</span> <span class="c1"># Preload both body and attachments.</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text="Message.all.with_rich_text_content # Preload the body without attachments.
Message.all.with_rich_text_content_and_embeds # Preload both body and attachments.
">复制</button>
</div>
<h3 id="api-backend-development"><a class="anchorlink" href="#api-backend-development" data-turbolinks="false">7 API / Backend development</a></h3>
<ol>
<li>
<p>A backend API (for example, using JSON) needs a separate endpoint for uploading files that creates an <code>ActiveStorage::Blob</code> and returns its <code>attachable_sgid</code>:</p>
<div class="code_container">
<pre><code class="highlight json"><span class="p">{</span><span class="w">
  </span><span class="nl">"attachable_sgid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BAh7CEkiCG…"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<button class="clipboard-button" data-clipboard-text='{
  "attachable_sgid": "BAh7CEkiCG…"
}
'>复制</button>
</div>
</li>
<li>
<p>Take that <code>attachable_sgid</code> and ask your frontend to insert it in rich text content using an <code>&lt;action-text-attachment&gt;</code> tag:</p>
<div class="code_container">
<pre><code class="highlight html"><span class="nt">&lt;action-text-attachment</span> <span class="na">sgid=</span><span class="s">"BAh7CEkiCG…"</span><span class="nt">&gt;&lt;/action-text-attachment&gt;</span>
</code></pre>
<button class="clipboard-button" data-clipboard-text='&lt;action-text-attachment sgid="BAh7CEkiCG…"&gt;&lt;/action-text-attachment&gt;
'>复制</button>
</div>
</li>
</ol>
<p>This is based on Basecamp, so if you still can't find what you are looking for, check this <a href="https://github.com/basecamp/bc3-api/blob/master/sections/rich_text.md">Basecamp Doc</a>.</p>

        <h3>反馈</h3>
        <p>
          衷心希望您能帮我们提升指南质量。
        </p>
        <p>
          您发现任何错误都可以帮助我们。
          如果想要参与贡献可以参阅<a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">文档贡献</a>章节获取相关细节。
        </p>
        <p>
          如果您发现有内容不完整或者有些内容需要更新，请进行相关补充和完善。
          开始之前要检查一下
          <a href="https://edgeguides.rubyonrails.org">体验版指南</a>中是否
          已经修复了这些问题，或者这些问题是否出现在主分支（main branch）内。
          如果以上检查完成后，确认为需要完善文档，请参考<a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南编写指导</a>，
          以确保您使用了正确的编写风格和编写习惯。
        </p>
        <p>
          如果您发现了一个问题，但是自己不会修复，请在 Github 
          <a href="https://github.com/rails/rails/issues">发一个问题帖子</a>。
        </p>
        <p>最后但不是不重要的是——<a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">Rubyonrails-Docs 邮件列表</a>
        欢迎大家提出任何关于 Ruby on Rails 文档的问题。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本作品基于<a href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>创作共享</p>
<p>“Rails”、“Ruby on Rails” 和 Rails 标志都是 David Heinemeier Hansson 注册的商标，版权所有。</p>

    </div>
  </div>
  <button id="back2Top">▲</button>
  <script>
		const button = document.querySelector("#back2Top");
		BACK2TOP(button, 200);
	</script>	
</body>
</html>
